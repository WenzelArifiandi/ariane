# PostgreSQL Client Authentication Configuration
# Cell v0 - Secure configuration allowing only K8s VM access

# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   all             postgres                                peer
local   all             all                                     peer

# IPv4 local connections:
host    all             postgres        127.0.0.1/32            scram-sha-256

# Allow postgres_exporter for monitoring
host    postgres        postgres_exporter 127.0.0.1/32         scram-sha-256

# Allow connections from Kubernetes VM only
{% for host in postgres_allowed_hosts | default([]) %}
host    {{ zitadel_db_name }}    {{ zitadel_db_user }}    {{ host }}/32    scram-sha-256
host    postgres        postgres_exporter {{ host }}/32         scram-sha-256
{% endfor %}

# Replication connections
local   replication     postgres                                peer
host    replication     postgres        127.0.0.1/32            scram-sha-256

# Deny all other connections
host    all             all             0.0.0.0/0               reject
host    all             all             ::/0                    reject