# K3s configuration for Cell v0
# Generated by Ansible

# Cluster configuration
cluster-init: {{ k3s_cluster_init | default(true) }}
token: {{ k3s_token | default('changeme-cluster-token') }}

# Network settings
cluster-cidr: {{ k3s_cluster_cidr | default('10.42.0.0/16') }}
service-cidr: {{ k3s_service_cidr | default('10.43.0.0/16') }}
cluster-dns: {{ k3s_cluster_dns | default('10.43.0.10') }}

# Node settings
node-name: {{ ansible_hostname }}
node-ip: {{ ansible_default_ipv4.address }}

# Security settings
protect-kernel-defaults: true

# Disable built-in components we'll replace with Helm
disable:
  - traefik
  - servicelb
  - local-storage
{% if k3s_disable_metrics_server | default(false) %}
  - metrics-server
{% endif %}

# Enable required features
kube-apiserver-arg:
  - --audit-log-maxage=30
  - --audit-log-maxbackup=3
  - --audit-log-maxsize=100
  - --audit-log-path=/var/log/audit.log
  - --request-timeout=300s

kube-controller-manager-arg:
  - --bind-address=0.0.0.0
  - --secure-port=10257

kube-scheduler-arg:
  - --bind-address=0.0.0.0
  - --secure-port=10259

# Kubelet configuration
kubelet-arg:
  - --max-pods={{ k3s_max_pods | default(110) }}
{% if k3s_kubelet_extra_args is defined %}
{% for arg in k3s_kubelet_extra_args %}
  - {{ arg }}
{% endfor %}
{% endif %}

# etcd configuration for high availability
{% if k3s_etcd_expose_metrics | default(false) %}
etcd-expose-metrics: true
{% endif %}

# Logging
log: /var/log/k3s.log
debug: {{ k3s_debug | default(false) }}