name: "ğŸ”’ Fix Pinned Dependencies"

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (show what would be changed)"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  fix-pinned-deps:
    name: "ğŸ”’ Pin GitHub Actions to Commit SHAs"
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0

      - name: "ğŸ” Install pin-github-action tool"
        run: |
          # Install the tool to pin GitHub Actions to commit SHAs
          npm install -g pin-github-action

      - name: "ğŸ”’ Pin Actions to Commit SHAs"
        run: |
          echo "ğŸ” Finding workflow files..."
          find .github/workflows -name "*.yml" -o -name "*.yaml" | while read workflow; do
            echo "ğŸ“ Processing $workflow..."

            if [ "${{ inputs.dry_run }}" = "true" ]; then
              echo "ğŸ§ª DRY RUN: Would pin actions in $workflow"
              pin-github-action --dry-run "$workflow"
            else
              pin-github-action "$workflow"
              echo "âœ… Pinned actions in $workflow"
            fi
          done

      - name: "ğŸ“Š Show Changes"
        if: ${{ !inputs.dry_run }}
        run: |
          echo "ğŸ“Š Files changed:"
          git diff --name-only

          echo "ğŸ“ˆ Stats:"
          git diff --stat

      - name: "ğŸ’¾ Commit Changes"
        if: ${{ !inputs.dry_run }}
        run: |
          git config --local user.email "security-fix@github.com"
          git config --local user.name "Security Fix Bot"

          if git diff --quiet && git diff --cached --quiet; then
            echo "âœ… No changes to commit"
            exit 0
          fi

          git add .github/workflows/

          CHANGED_FILES=$(git diff --cached --name-only | wc -l)

          git commit -m "ğŸ”’ Pin GitHub Actions to commit SHAs for security

ğŸ›¡ï¸ Security improvement: Pin all GitHub Actions to specific commit SHAs
to prevent supply chain attacks and ensure reproducible builds.

ğŸ“Š Files updated: $CHANGED_FILES workflow files
ğŸ¯ Fixes: PinnedDependenciesID code scanning alerts

ğŸ¤– Automated security fix
ğŸ”— Reference: https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions

Co-authored-by: Security Fix Bot <security-fix@github.com>"

          git push

      - name: "ğŸ“ˆ Summary"
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "ğŸ§ª DRY RUN completed - no changes made"
          else
            CHANGED=$(git log -1 --name-only --pretty=format: | wc -l)
            echo "âœ… Pinned dependencies in $CHANGED workflow files"
          fi