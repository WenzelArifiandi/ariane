name: 🧪 Snyk Security Scan (Optional)

on:
  schedule:
    - cron: '0 4 * * 0' # Weekly on Sundays at 04:00 UTC
  workflow_dispatch:
    inputs:
      snyk_token:
        description: 'Snyk API token (optional, for manual runs)'
        required: false
        type: string

permissions:
  contents: read
  security-events: write

jobs:
  snyk-scan:
    name: 🔍 Snyk Scan
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: 🧪 Run Snyk if token present
        env:
          SNYK_TOKEN: ${{ inputs.snyk_token }}
        continue-on-error: true
        run: |
          if [ -z "${SNYK_TOKEN}" ]; then
            echo "ℹ️ SNYK_TOKEN not configured; skipping Snyk scan"
            exit 0
          fi

          echo "🔍 Installing Snyk CLI..."
          npm -g i snyk@latest

          echo "🔎 Running Snyk across workspaces..."
          # Site
          if [ -f site/package.json ]; then
            (cd site && snyk test --severity-threshold=medium || true)
          fi
          # Studio
          if [ -f studio/package.json ]; then
            (cd studio && snyk test --severity-threshold=medium || true)
          fi

          echo "✅ Snyk scan complete"