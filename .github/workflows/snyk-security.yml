name: ğŸ§ª Snyk Security Scan (Optional)

on:
  schedule:
    - cron: "0 4 * * 0" # Weekly on Sundays at 04:00 UTC
  workflow_dispatch:
    inputs:
      snyk_token:
        description: "Snyk API token (optional, for manual runs)"
        required: false
        type: string

permissions:
  contents: read
  security-events: write

jobs:
  snyk-scan:
    name: ğŸ” Snyk Scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      - name: ğŸ§ª Run Snyk if token present
        env:
          # Manual input provided via workflow_dispatch; secret fallback resolved inside script via environment
          SNYK_TOKEN_INPUT: ${{ inputs.snyk_token }}
        continue-on-error: true
        run: |
          # Resolve token: prefer input; else use SNYK_TOKEN if set as an env/secret at runtime
          SNYK_TOKEN="${SNYK_TOKEN_INPUT:-$SNYK_TOKEN}"
          if [ -z "${SNYK_TOKEN}" ]; then
            echo "â„¹ï¸ Snyk token not configured (no input and no secret); skipping Snyk scan"
            exit 0
          fi

          echo "ğŸ” Installing Snyk CLI..."
          npm -g i snyk@latest
          export SNYK_TOKEN

          echo "ğŸ” Running Snyk across workspaces..."
          # Site
          if [ -f site/package.json ]; then
            (cd site && snyk test --severity-threshold=medium || true)
          fi
          # Studio
          if [ -f studio/package.json ]; then
            (cd studio && snyk test --severity-threshold=medium || true)
          fi

          echo "âœ… Snyk scan complete"
