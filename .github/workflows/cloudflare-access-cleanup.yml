name: "Cleanup Cloudflare Access Resources"

on:
    workflow_dispatch:

env:
    CLOUDFLARE_API_TOKEN: ${{ secrets.TERRAFORM_ACCESS }}
    CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
    cleanup:
        name: "Delete Existing Resources"
        runs-on: ubuntu-latest
        environment: prod
        permissions:
            contents: read

        steps:
            - name: Delete Access Application
              continue-on-error: true
              run: |
                  echo "ðŸ—‘ï¸ Deleting Access Application..."

                  # Application ID from previous discovery
                  APP_ID="2768b19d-a8a6-4866-b42f-f4881629edaf"

                  curl -X DELETE \
                    "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/access/apps/${APP_ID}" \
                    -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
                    -H "Content-Type: application/json" | jq '.'

                  echo "âœ… Application deleted"

            - name: Delete Identity Provider
              continue-on-error: true
              run: |
                  echo "ðŸ—‘ï¸ Deleting Identity Provider..."

                  # Identity Provider ID from previous discovery
                  IDP_ID="8dea90ab-5226-4b41-b8a0-3e9db7d91c7e"

                  curl -X DELETE \
                    "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/access/identity_providers/${IDP_ID}" \
                    -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
                    -H "Content-Type: application/json" | jq '.'

                  echo "âœ… Identity Provider deleted"

            - name: List and Delete Service Tokens
              continue-on-error: true
              run: |
                  echo "ðŸ—‘ï¸ Finding and deleting Service Tokens..."

                  # Get all service tokens
                  TOKENS=$(curl -s \
                    "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/access/service_tokens" \
                    -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
                    -H "Content-Type: application/json")

                  echo "$TOKENS" | jq '.'

                  # Find Cipher token and delete
                  TOKEN_ID=$(echo "$TOKENS" | jq -r '.result[] | select(.name | test("Cipher"; "i")) | .id' | head -1)

                  if [[ -n "$TOKEN_ID" ]] && [[ "$TOKEN_ID" != "null" ]]; then
                      echo "Found token: $TOKEN_ID"
                      curl -X DELETE \
                        "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/access/service_tokens/${TOKEN_ID}" \
                        -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
                        -H "Content-Type: application/json" | jq '.'
                      echo "âœ… Service Token deleted"
                  else
                      echo "â„¹ï¸  No Cipher service token found"
                  fi

            - name: Summary
              run: |
                  echo "## âœ… Cleanup Complete" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "All existing Cloudflare Access resources have been deleted." >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ðŸŽ¯ Next Step:" >> $GITHUB_STEP_SUMMARY
                  echo "Run the main deployment workflow to recreate resources with proper configuration:" >> $GITHUB_STEP_SUMMARY
                  echo '```bash' >> $GITHUB_STEP_SUMMARY
                  echo 'gh workflow run cloudflare-access.yml -f action=apply' >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
